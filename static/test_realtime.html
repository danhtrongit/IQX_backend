<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IQX Realtime Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #00d4ff;
        }
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #16213e;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4757;
        }
        .status-dot.connected {
            background: #2ed573;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        input, button, select {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
        }
        input {
            background: #0f3460;
            color: #fff;
            width: 200px;
        }
        button {
            background: #00d4ff;
            color: #1a1a2e;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        button:hover {
            background: #00a8cc;
        }
        button.danger {
            background: #ff4757;
            color: #fff;
        }
        button.success {
            background: #2ed573;
            color: #1a1a2e;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        @media (max-width: 900px) {
            .grid { grid-template-columns: 1fr; }
        }
        .panel {
            background: #16213e;
            border-radius: 10px;
            overflow: hidden;
        }
        .panel-header {
            background: #0f3460;
            padding: 15px 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-body {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        /* Index Cards */
        .index-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        .index-card {
            background: #0f3460;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
        }
        .index-card.up {
            border-left: 4px solid #2ed573;
        }
        .index-card.down {
            border-left: 4px solid #ff4757;
        }
        .index-name {
            font-size: 14px;
            color: #888;
            margin-bottom: 5px;
        }
        .index-value {
            font-size: 28px;
            font-weight: 700;
        }
        .index-change {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 14px;
        }
        .index-change .up { color: #2ed573; }
        .index-change .down { color: #ff4757; }
        .index-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #1a1a2e;
            font-size: 12px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-label { color: #888; }
        .stat-value { font-weight: 600; margin-top: 3px; }
        .stat-value.green { color: #2ed573; }
        .stat-value.red { color: #ff4757; }
        .stat-value.yellow { color: #ffa502; }
        /* Stock Table */
        .stock-table {
            width: 100%;
            border-collapse: collapse;
        }
        .stock-table th, .stock-table td {
            padding: 10px;
            text-align: right;
            border-bottom: 1px solid #0f3460;
        }
        .stock-table th {
            background: #0f3460;
            font-weight: 600;
            text-align: center;
        }
        .stock-table td:first-child {
            text-align: left;
            font-weight: 600;
            color: #00d4ff;
        }
        .stock-table tr:hover {
            background: #0f3460;
        }
        .stock-table tr.flash-up {
            animation: flashUp 0.5s;
        }
        .stock-table tr.flash-down {
            animation: flashDown 0.5s;
        }
        @keyframes flashUp {
            0%, 100% { background: transparent; }
            50% { background: rgba(46, 213, 115, 0.3); }
        }
        @keyframes flashDown {
            0%, 100% { background: transparent; }
            50% { background: rgba(255, 71, 87, 0.3); }
        }
        .price-up { color: #2ed573; }
        .price-down { color: #ff4757; }
        .price-ref { color: #ffa502; }
        /* Log Panel */
        .log-panel {
            background: #16213e;
            border-radius: 10px;
            margin-top: 20px;
        }
        .log-body {
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
        }
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #0f3460;
        }
        .log-time { color: #888; }
        .log-type { 
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin: 0 5px;
        }
        .log-type.price { background: #2ed573; color: #1a1a2e; }
        .log-type.index { background: #00d4ff; color: #1a1a2e; }
        .log-type.system { background: #ffa502; color: #1a1a2e; }
        .log-type.error { background: #ff4757; color: #fff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ IQX Realtime Test</h1>
        
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Disconnected</span>
            </div>
            <div class="controls">
                <input type="text" id="symbolInput" placeholder="Symbols (VNM,FPT,VCB)" value="VNM,FPT,VCB,HPG,MWG">
                <button onclick="connect()" class="success">Connect</button>
                <button onclick="disconnect()" class="danger">Disconnect</button>
                <button onclick="subscribe()">Subscribe</button>
                <button onclick="getIndices()">Get Indices</button>
                <button onclick="getCached()">Get Cached</button>
                <button onclick="clearLogs()">Clear Logs</button>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid">
            <!-- Index Panel -->
            <div class="panel">
                <div class="panel-header">
                    <span>üìä Market Indices</span>
                    <span id="indexUpdateTime">--:--:--</span>
                </div>
                <div class="panel-body">
                    <div class="index-grid" id="indexGrid">
                        <!-- Index cards will be inserted here -->
                        <div class="index-card">
                            <div class="index-name">Waiting for data...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stock Panel -->
            <div class="panel">
                <div class="panel-header">
                    <span>üìà Stock Prices</span>
                    <span id="stockUpdateTime">--:--:--</span>
                </div>
                <div class="panel-body">
                    <table class="stock-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Price</th>
                                <th>Change</th>
                                <th>%</th>
                                <th>Volume</th>
                                <th>Side</th>
                            </tr>
                        </thead>
                        <tbody id="stockTable">
                            <tr><td colspan="6" style="text-align:center">Waiting for data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Log Panel -->
        <div class="log-panel">
            <div class="panel-header">
                <span>üìù Event Log</span>
                <span id="logCount">0 events</span>
            </div>
            <div class="log-body" id="logBody">
                <!-- Logs will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let stockData = {};
        let indexData = {};
        let logCount = 0;

        // WebSocket URL
        const WS_URL = `ws://${window.location.host}/api/v1/ws/prices`;

        function connect() {
            const symbols = document.getElementById('symbolInput').value;
            const url = `${WS_URL}?symbols=${symbols}`;
            
            addLog('system', `Connecting to ${url}`);
            
            ws = new WebSocket(url);
            
            ws.onopen = () => {
                document.getElementById('statusDot').classList.add('connected');
                document.getElementById('statusText').textContent = 'Connected';
                addLog('system', 'WebSocket connected');
            };
            
            ws.onclose = () => {
                document.getElementById('statusDot').classList.remove('connected');
                document.getElementById('statusText').textContent = 'Disconnected';
                addLog('system', 'WebSocket disconnected');
            };
            
            ws.onerror = (e) => {
                addLog('error', `WebSocket error: ${e.message || 'Unknown error'}`);
            };
            
            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    handleMessage(msg);
                } catch (e) {
                    addLog('error', `Parse error: ${e.message}`);
                }
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function subscribe() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addLog('error', 'Not connected');
                return;
            }
            const symbols = document.getElementById('symbolInput').value.split(',').map(s => s.trim());
            ws.send(JSON.stringify({ action: 'subscribe', symbols }));
            addLog('system', `Subscribing to: ${symbols.join(', ')}`);
        }

        function getIndices() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addLog('error', 'Not connected');
                return;
            }
            ws.send(JSON.stringify({ action: 'get_indices' }));
            addLog('system', 'Requesting indices data');
        }

        function getCached() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addLog('error', 'Not connected');
                return;
            }
            ws.send(JSON.stringify({ action: 'get_cached' }));
            addLog('system', 'Requesting cached prices');
        }

        function handleMessage(msg) {
            switch (msg.type) {
                case 'price':
                    handlePrice(msg.data);
                    break;
                case 'index':
                    handleIndex(msg.data);
                    break;
                case 'indices':
                    // Bulk indices response
                    if (msg.data) {
                        Object.values(msg.data).forEach(idx => handleIndex(idx));
                    }
                    addLog('index', `Received ${Object.keys(msg.data || {}).length} indices`);
                    break;
                case 'cached_prices':
                    if (msg.data) {
                        Object.values(msg.data).forEach(p => handlePrice(p));
                    }
                    addLog('price', `Received ${Object.keys(msg.data || {}).length} cached prices`);
                    break;
                case 'subscribed':
                    addLog('system', `Subscribed to: ${msg.symbols?.join(', ')}`);
                    break;
                case 'pong':
                    addLog('system', 'Pong received');
                    break;
                case 'error':
                    addLog('error', msg.message);
                    break;
                default:
                    addLog('system', `Unknown message type: ${msg.type}`);
            }
        }

        function handlePrice(data) {
            if (!data || !data.symbol) return;
            
            const symbol = data.symbol;
            const oldPrice = stockData[symbol]?.last_price;
            stockData[symbol] = data;
            
            updateStockTable(symbol, oldPrice);
            document.getElementById('stockUpdateTime').textContent = new Date().toLocaleTimeString();
            
            // Only log occasionally to avoid spam
            if (Math.random() < 0.1) {
                addLog('price', `${symbol}: ${formatNumber(data.last_price)} (${formatPercent(data.change_percent)})`);
            }
        }

        function handleIndex(data) {
            if (!data || !data.index_id) return;
            
            indexData[data.index_id] = data;
            updateIndexGrid();
            document.getElementById('indexUpdateTime').textContent = new Date().toLocaleTimeString();
            
            // Log index updates
            addLog('index', `${data.index_id}: ${formatNumber(data.current_index, 2)} (${formatPercent(data.percent_change)})`);
        }

        function updateStockTable(symbol, oldPrice) {
            const tbody = document.getElementById('stockTable');
            let row = document.getElementById(`stock-${symbol}`);
            const data = stockData[symbol];
            
            if (!row) {
                // Clear "waiting" message if first data
                if (tbody.querySelector('td[colspan]')) {
                    tbody.innerHTML = '';
                }
                row = document.createElement('tr');
                row.id = `stock-${symbol}`;
                tbody.appendChild(row);
            }
            
            const priceClass = getPriceClass(data.change);
            const newPrice = data.last_price;
            
            // Flash animation
            if (oldPrice && newPrice !== oldPrice) {
                row.classList.remove('flash-up', 'flash-down');
                row.classList.add(newPrice > oldPrice ? 'flash-up' : 'flash-down');
                setTimeout(() => row.classList.remove('flash-up', 'flash-down'), 500);
            }
            
            row.innerHTML = `
                <td>${symbol}</td>
                <td class="${priceClass}">${formatNumber(data.last_price)}</td>
                <td class="${priceClass}">${formatChange(data.change)}</td>
                <td class="${priceClass}">${formatPercent(data.change_percent)}</td>
                <td>${formatVolume(data.total_volume)}</td>
                <td>${getSideIcon(data.side)}</td>
            `;
        }

        // Priority order for displaying indices
        const INDEX_PRIORITY = [
            'VNINDEX', 'VN30', 'VN100', 'VNALL',
            'HNX-INDEX', 'HNX30', 'HNXLCAP', 'HNXSMCAP',
            'UPCOM-INDEX'
        ];

        function updateIndexGrid() {
            const grid = document.getElementById('indexGrid');
            const indices = Object.values(indexData);
            
            if (indices.length === 0) return;
            
            // Sort by priority, then alphabetically
            indices.sort((a, b) => {
                const aIdx = INDEX_PRIORITY.indexOf(a.index_id);
                const bIdx = INDEX_PRIORITY.indexOf(b.index_id);
                if (aIdx !== -1 && bIdx !== -1) return aIdx - bIdx;
                if (aIdx !== -1) return -1;
                if (bIdx !== -1) return 1;
                return a.index_id.localeCompare(b.index_id);
            });
            
            grid.innerHTML = indices.map(idx => {
                const isUp = idx.change >= 0;
                const exchange = idx.exchange || '';
                return `
                    <div class="index-card ${isUp ? 'up' : 'down'}">
                        <div class="index-name">${idx.index_id} <span style="color:#666">(${exchange})</span></div>
                        <div class="index-value ${isUp ? 'price-up' : 'price-down'}">
                            ${formatNumber(idx.current_index, 2)}
                        </div>
                        <div class="index-change">
                            <span class="${isUp ? 'up' : 'down'}">
                                ${isUp ? '‚ñ≤' : '‚ñº'} ${formatNumber(Math.abs(idx.change || 0), 2)}
                            </span>
                            <span class="${isUp ? 'up' : 'down'}">
                                (${idx.percent_change != null ? (idx.percent_change >= 0 ? '+' : '') + idx.percent_change.toFixed(2) + '%' : '--'})
                            </span>
                        </div>
                        <div class="index-stats">
                            <div class="stat-item">
                                <div class="stat-label">Volume</div>
                                <div class="stat-value">${formatVolume(idx.volume)}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Value</div>
                                <div class="stat-value">${formatValue(idx.value)}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Open</div>
                                <div class="stat-value">${formatNumber(idx.open_index, 2)}</div>
                            </div>
                        </div>
                        <div class="index-stats" style="border-top: none; padding-top: 5px;">
                            <div class="stat-item">
                                <div class="stat-label">TƒÉng</div>
                                <div class="stat-value green">${idx.advances || 0}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Gi·∫£m</div>
                                <div class="stat-value red">${idx.declines || 0}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">ƒê·ª©ng</div>
                                <div class="stat-value yellow">${idx.unchanged || 0}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function formatValue(val) {
            if (val == null) return '--';
            if (val >= 1000000000000) return (val / 1000000000000).toFixed(1) + 'T';
            if (val >= 1000000000) return (val / 1000000000).toFixed(1) + 'B';
            if (val >= 1000000) return (val / 1000000).toFixed(1) + 'M';
            return formatNumber(val);
        }

        function addLog(type, message) {
            const logBody = document.getElementById('logBody');
            const time = new Date().toLocaleTimeString();
            
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-time">${time}</span>
                <span class="log-type ${type}">${type.toUpperCase()}</span>
                <span>${message}</span>
            `;
            
            logBody.insertBefore(entry, logBody.firstChild);
            
            // Keep only last 100 logs
            while (logBody.children.length > 100) {
                logBody.removeChild(logBody.lastChild);
            }
            
            logCount++;
            document.getElementById('logCount').textContent = `${logCount} events`;
        }

        function clearLogs() {
            document.getElementById('logBody').innerHTML = '';
            logCount = 0;
            document.getElementById('logCount').textContent = '0 events';
        }

        // Utility functions
        function formatNumber(num, decimals = 0) {
            if (num == null) return '--';
            return num.toLocaleString('vi-VN', { 
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals 
            });
        }

        function formatChange(change) {
            if (change == null) return '--';
            const sign = change >= 0 ? '+' : '';
            return sign + formatNumber(change);
        }

        function formatPercent(pct) {
            if (pct == null) return '--';
            const sign = pct >= 0 ? '+' : '';
            return sign + (pct * 100).toFixed(2) + '%';
        }

        function formatVolume(vol) {
            if (vol == null) return '--';
            if (vol >= 1000000) return (vol / 1000000).toFixed(1) + 'M';
            if (vol >= 1000) return (vol / 1000).toFixed(1) + 'K';
            return vol.toString();
        }

        function getPriceClass(change) {
            if (change == null) return '';
            if (change > 0) return 'price-up';
            if (change < 0) return 'price-down';
            return 'price-ref';
        }

        function getSideIcon(side) {
            if (side === 'BU') return '<span class="price-up">‚ñ≤ BU</span>';
            if (side === 'SD') return '<span class="price-down">‚ñº SD</span>';
            return '<span class="price-ref">‚óè UN</span>';
        }

        // Auto-connect on page load
        window.onload = () => {
            addLog('system', 'Page loaded. Click Connect to start.');
        };
    </script>
</body>
</html>
